# Dev Container with Traefik routing
#
# Prerequisites: Start Traefik first:
#   docker compose -f ~/.local/share/chezmoi/docker/traefik/docker-compose.yml up -d
#
# Access (PROJECT_NAME defaults to parent directory name):
#   Frontend: http://${PROJECT_NAME}.dev.local:3000
#   Backend:  http://${PROJECT_NAME}.dev.local:9999
#
# Add to /etc/hosts: 127.0.0.1 *.dev.local (or use Acrylic DNS on Windows)

services:
  dev:
    env_file: ../.env
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USER_UID: ${USER_UID:-1000}
        USER_GID: ${USER_GID:-1000}
    volumes:
      - ..:/workspaces/project:cached
      # Mount worktree at same host path so git worktree paths resolve correctly
      - ${WORKTREE_DIR:-/tmp/empty}:${WORKTREE_DIR:-/tmp/empty}:cached
      # Mount main .git at same path for worktree support
      - ${MAIN_GIT_DIR:-/tmp/empty}:${MAIN_GIT_DIR:-/tmp/empty}:cached
      - ${CHEZMOI_SOURCE:-~/.local/share/chezmoi}:/home/dev/.local/share/chezmoi:ro
      - ~/.claude:/home/dev/.claude
      - ~/.claude.json:/home/dev/.claude.json
      - ~/.ssh:/home/dev/.ssh:ro
      - ~/.config/gh:/home/dev/.config/gh:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - go-mod-cache:/home/dev/go/pkg/mod
      - npm-cache:/home/dev/.npm
    environment:
      PORT: "9999"
      PROJECT_NAME: ${PROJECT_NAME}
      VITE_API_URL: "http://${PROJECT_NAME}.dev.local:9999"
      ENVIRONMENT: development
      DATABASE_URL: postgres://postgres:postgres@db:5432/league_draft?sslmode=disable
      JWT_SECRET: dev-container-jwt-secret
      JWT_EXPIRATION_HOURS: "24"
      DEFAULT_TIMER_SECONDS: "30"
      TERM: xterm-256color
      COLORTERM: truecolor
      CLAUDE_CONFIG_DIR: /home/dev/.claude
      PATH: "/home/dev/.local/bin:/home/dev/.local/share/fnm:/home/dev/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    stdin_open: true
    tty: true
    working_dir: /workspaces/project
    command: sleep infinity
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - traefik-dev
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-dev"
      # Frontend routing (npm run dev on port 3000)
      - "traefik.http.routers.${PROJECT_NAME}-frontend.rule=Host(`${PROJECT_NAME}.dev.local`)"
      - "traefik.http.routers.${PROJECT_NAME}-frontend.entrypoints=port3000"
      - "traefik.http.routers.${PROJECT_NAME}-frontend.service=${PROJECT_NAME}-frontend"
      - "traefik.http.services.${PROJECT_NAME}-frontend.loadbalancer.server.port=3000"
      # Backend routing (go run on port 9999)
      - "traefik.http.routers.${PROJECT_NAME}-backend.rule=Host(`${PROJECT_NAME}.dev.local`)"
      - "traefik.http.routers.${PROJECT_NAME}-backend.entrypoints=port9999"
      - "traefik.http.routers.${PROJECT_NAME}-backend.service=${PROJECT_NAME}-backend"
      - "traefik.http.services.${PROJECT_NAME}-backend.loadbalancer.server.port=9999"
      # Playwright UI routing (port 7070)
      - "traefik.http.routers.${PROJECT_NAME}-playwright.rule=Host(`${PROJECT_NAME}.dev.local`)"
      - "traefik.http.routers.${PROJECT_NAME}-playwright.entrypoints=port7070"
      - "traefik.http.routers.${PROJECT_NAME}-playwright.service=${PROJECT_NAME}-playwright"
      - "traefik.http.services.${PROJECT_NAME}-playwright.loadbalancer.server.port=7070"
    depends_on:
      db:
        condition: service_healthy

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: league_draft
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

networks:
  traefik-dev:
    external: true

volumes:
  go-mod-cache:
  npm-cache:
  postgres-data:
